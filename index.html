<!DOCTYPE html>
<!-- Created by Deltaion Lee (MCMi460) on Github -->
<html>
  <head>
    <meta charset = 'utf-8'>

    <!-- Some cosmetics -->
    <link rel = 'shortcut icon' href = './static/images/smotas.png' />
    <meta name = 'author' content = 'MCMi460'>
    <meta name = 'description' content = 'An online Nintendo Switch TAS-ing tool designed for your comfort of use!'>
    <meta name = 'keywords' content = 'TAS, Nintendo Switch, Super Mario Odyssey, Development, Tool'>
    <meta name = 'theme-color' content = '#f018cf'>
    <meta property = 'og:title' content = 'TAS-Online' />
    <meta property = 'og:image' content = './static/images/smotas.png' />

    <title>TAS-Online</title>
  </head>

  <!-- Beginning of JS -->
  <script>
  const keys = [
    'NONE',
    'KEY_A',
    'KEY_B',
    'KEY_X',
    'KEY_Y',
    'KEY_L',
    'KEY_R',
    'KEY_ZL',
    'KEY_ZR',
    'KEY_PLUS',
    'KEY_MINUS',
    'KEY_DLEFT',
    'KEY_DUP',
    'KEY_DRIGHT',
    'KEY_DDOWN',
    'KEY_LSTICK',
    'KEY_RSTICK',
  ];
  const YES = '✅';
  const NO = '⛔';
  var buffer = '1 KEY_B 0;0 0;0\n6 KEY_ZL 0;0 0;0\n41 KEY_ZL;KEY_Y 0;0 0;0\n43 KEY_X;KEY_A 30000;0 0;0\n44 KEY_A 30000;0 0;0\n45 KEY_A 30000;0 0;0\n46 KEY_A 30000;0 0;0\n47 KEY_A 30000;0 0;0';
  var pasteboard = 'NONE 0;0 0;0';

  function setupUI() {
    // Create table columns
    var apparatus = document.getElementById('apparatus');
    var main = document.getElementById('main');
    document.getElementById('file-dialog').value = '';
    try {
    loadHeader();
    populateTable();

    var sec = 0

    function cycle() {
      sec = (Number(sec) + .01).toFixed(2);

      fillText(sec);
    }

    fillText(sec);
    setInterval(cycle,10);

    // Create listener for tableUpdate
    const updateEvent = document.querySelector('#apparatus');
    updateEvent.addEventListener('click', function (e) {
      try {
        let cell = e.target.closest('td');
        if (!cell) {
          return;
        }
        let row = cell.parentElement.rowIndex;
        let col = cell.cellIndex;

        if (cell.className == 'frame') {
          let prompt = window.prompt('After which frame should this one be placed?', '1');
          if (prompt) {
            let frame = Number(prompt);
            if (Number.isInteger(frame)) {
              copy(row);
              removeRow(row);
              paste(frame);
            }
          }
        } else if (cell.className == 'lstick' || cell.className == 'rstick') {
          let prompt1 = window.prompt('What should the X coordinate be?', '0');
          if (prompt1) {
            let prompt2 = window.prompt('What should the Y coordinate be?', '0');
            if (prompt2) {
              let stick1 = Number(prompt1);
              let stick2 = Number(prompt2);
              if ( Number.isInteger(stick1) && Number.isInteger(stick2) ) {
                if (stick1 > 32767) {
                  stick1 = 32767;
                } else if (stick1 < -32767) {
                  stick1 = -32767;
                } if (stick2 > 32767) {
                  stick2 = 32767;
                } else if (stick2 < -32767) {
                  stick2 = -32767;
                }
                apparatus.children[row].children[col].innerHTML = `${stick1},${stick2}`;
                apparatus.children[row].children[col].title = `${stick1},${stick2}`;
            }

          }

          }
        } else if (cell.className == 'key') {
          if (apparatus.children[row].children[col].innerHTML == YES) {
            apparatus.children[row].children[col].innerHTML = NO;
          } else {
            apparatus.children[row].children[col].innerHTML = YES;
          }
        }

        tableUpdate(row, col);
      } catch (e) {
        console.log(e);
        main.innerHTML += `<h3 style='color:#d11b24;'>${e}</h3>`;
      }
    });
    // End of listeners

    } catch (e) {
      console.log(e);
      main.innerHTML += `<h3 style='color:#d11b24;'>${e}</h3>`;
    }
  }

  function copy(index) {
    let row = apparatus.children[index].children;

    let frame = row[0].innerHTML;

    let key = [];
    for (let n = 3; n < row.length; n++) {
      if (row[n].innerHTML == YES) {
        key.push(keys[n - 2]);
      }
    }
    if (key == '') {
      key = ['NONE',];
    }
    key = key.join(';');

    lstick = row[1].innerHTML.split(',').map(Number);
    rstick = row[2].innerHTML.split(',').map(Number);

    pasteboard = `${key} ${lstick.join(';')} ${rstick.join(';')}\n`;
    return pasteboard;
  }

  function paste(frame,data = pasteboard) {
    let tempBuffer = buffer.split('\n');

    let possibleFrame = 0;
    for (let i = 0; i < tempBuffer.length; i++) {
      if (!tempBuffer[i] || !/\S/.test(tempBuffer[i])) {
        continue;
      }
      possibleFrame = Number(tempBuffer[i].split(' ')[0]);
      if (possibleFrame > frame) {
        tempBuffer.splice(i, 0, `${frame} ${data}`);
        break;
      }
      possibleFrame += 1;
    }
    if (possibleFrame == Number(tempBuffer[tempBuffer.length - 1].split(' ')[0]) + 1 || (tempBuffer.length == 1 && tempBuffer[0] == '') ) {
      tempBuffer.push(`${frame} ${data}`);
    }
    buffer = tempBuffer.join('\n');

    // Refill the table
    populateTable();
  }

  function newFrame() {
    let frame = 0;
    if (apparatus.children.length > 1) {
      frame = Number(apparatus.children[apparatus.children.length - 1].children[0].innerHTML);
    }
    paste(frame + 1,'NONE 0;0 0;0');
  }

  function delFrame() {
    if (apparatus.children.length > 1) {
      var option = Number(apparatus.children[1].children[0].innerHTML);
    } else {
      return;
    }
    let prompt = window.prompt('Which frame should be removed?', option);
    if (!prompt) {
      return;
    }
    let frame = Number(prompt);
    if (Number.isInteger(frame)) {
      let rows = apparatus.children;
      for (let i = 1; i < rows.length; i++) {
        if (Number(rows[i].children[0].innerHTML) == frame) {
          apparatus.removeChild(rows[i]);
          break;
        }
      }
    }

    tableUpdate(0,0);
  }

  function readFile(event) {
    try {
      var input = event.target;

      var reader = new FileReader();
      reader.onload = function() {
        buffer = reader.result;
        populateTable(true);
      };
      reader.readAsText(input.files[0]);
    } catch (e) {
      console.log(e);
      main.innerHTML += `<h3 style='color:#d11b24;'>${e}</h3>`;
    }
  }

  function downloadBuffer() {
    let elem = document.createElement('a');
    elem.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(buffer));
    elem.setAttribute('download', 'script.txt');

    elem.style.display = 'none';
    document.body.appendChild(elem);

    elem.click();

    document.body.removeChild(elem);
  }

  function loadHeader() {
    let columns = [];
    columns.push(...keys);
    columns.shift();
    columns.unshift('Frame','L-Stick','R-Stick');
    const header = apparatus.querySelector('#header');
    for (let i = 0; i < columns.length; i++)  {
      let td = document.createElement('td');
      let text = columns[i];
      if (i > 2) {
        text = text.substring(4);
      }
      td.innerHTML = text; td.title = text; td.className = 'header';
      header.appendChild(td);
    }
  }

  function populateTable(newFile = false) {
    while (apparatus.children.length > 1) {
      apparatus.removeChild(apparatus.lastChild);
    }

    const lines = buffer.split('\n');
    for (let i = 0; i < lines.length; i++) {
      // Create row
      let line = lines[i].split(' ');
      if (!line || !/\S/.test(line)) {
        continue;
      }
      let row = document.createElement('tr');

      // Frame
      let frame = document.createElement('td'); frame.className = 'frame';
      frame.innerHTML = line[0];
      row.appendChild(frame);

      // Sticks
      let stick1 = line[2].split(';').map(Number); let stick2 = line[3].split(';').map(Number);
      let lstick = document.createElement('td'); let rstick = document.createElement('td');
      lstick.className = 'lstick'; rstick.className = 'rstick';
      lstick.innerHTML = stick1; rstick.innerHTML = stick2;
      lstick.title = stick1; rstick.title = stick2;
      row.appendChild(lstick); row.appendChild(rstick);

      // Keys
      let key = line[1].split(';');
      for (let n = 0; n < key.length; n++) {
        if (!keys.includes(key[n])) {
          throw `Key at frame ${line[0]} [Input #${apparatus.children.length}] does not exist.`
        }
      }
      for (let n = 1; n < keys.length; n++) {
        let keyElem = document.createElement('td'); keyElem.className = 'key';
        if (key.includes(keys[n])) {
          keyElem.innerHTML = YES;
        } else {
          keyElem.innerHTML = NO;
        }
        row.appendChild(keyElem);
      }

      apparatus.appendChild(row);
    }
    buffer = sortTable();
    if (newFile) {
      tableUpdate(0,0);
    }
  }

  function sortTable() {
    let rows = apparatus.children;
    let data = [];
    let possibleFrame = 0;
    for (let i = 1; i < rows.length; i++) {
      let row = rows[i].children;

      // Get frame
      let frame = Number(row[0].innerHTML);

      // Get keys
      let key = [];
      for (let n = 3; n < row.length; n++) {
        if (row[n].innerHTML == YES) {
          key.push(keys[n - 2]);
        }
      }
      if (key == '') {
        key = ['NONE',];
      }
      key = key.join(';');

      // Get sticks
      let lstick = row[1].innerHTML.split(',').map(Number);
      let rstick = row[2].innerHTML.split(',').map(Number);

      if (possibleFrame < frame) {
        possibleFrame = frame;
      } else {
        frame = possibleFrame + 1;
        possibleFrame = frame;
      }

      // Write to string variable
      data.push(`${frame} ${key} ${lstick.join(';')} ${rstick.join(';')}`);
    }
    data.sort(function(elem) {
      return Number(elem.split(' ')[0]);
    }).reverse();
    return data.join('\n');
  }

  function removeRow(row) {
    row = apparatus.children[row];
    apparatus.removeChild(row);
    tableUpdate(0,0);
    return row;
  }

  function fillText(sec = 0) {
    let textarea = document.getElementById('sidebar').children[1];

    let tag = `Buffer updated at ${Date.now()} (${sec} seconds of runtime)`;

    textarea.title = tag;
    textarea.innerHTML = '<code>' + buffer.replaceAll('\n','<br>') + `</code><br><br>${tag}`;
  }

  // Events

  function tableUpdate(row, col) {
    // Sort table, then write the changes
    buffer = sortTable();
    // Fill table
    populateTable();
  }

  function sidebar(toggle) {
    let width = '0%';
    if (toggle) {
      width = '25%';
    }
    document.getElementById('sidebar').style.width = width;
  }

  </script>
  <!-- End of JS -->

  <!-- Beginning of HTML -->
  <body onload='setupUI();'>

    <div
      id='sidebar'
      class = 'sidebar'
    >

      <a href = 'javascript:sidebar(false);' id = 'closeSidebar'>
        &times;
      </a>

      <p>

      </p>

      <p>
        Created and designed by <a href = 'https://github.com/MCMi460'>Deltaion Lee (MCMi460)</a>
        <br><br>
        Built using <a href = 'https://github.com/hamhub7/tas-script/blob/master/lua/lib/nxtas.md'>nx-TAS</a> by <a href = 'https://github.com/hamhub7'>hamhub7</a>
        <br><br>
        <a href = 'https://github.com/MCMi460/TAS-Online'>See on Github</a>!
        <br><br><br>
        <a href = 'javascript:window.location.reload();'>Reset page</a>
      </p>

    </div>

    <div
      id = 'banner'
    >

      <a href = 'javascript:sidebar(true);' id = 'openSidebar'>&#9776;</a>
      <h1><i>TAS-Online Editor</i></h1>

    </div>

    <div
      id = 'main'
    >

    <input type = 'file' id = 'file-dialog' accept = 'text/plain' onchange = 'readFile(event);'>
    <button onclick = 'downloadBuffer();'>Save progress</button>
    <button onclick = 'newFrame();'>Add Frame</button>
    <button onclick = 'delFrame();'>Remove Frame</button>

    </div>

    <div
      id = 'apparatus-container'
    >
      <table id = 'apparatus'>
        <tr id = 'header'>

        </tr>
      </table>
    </div>

  </body>
  <!-- End of HTML -->

  <!-- Beginning of CSS -->
  <style>

  @font-face {
    font-family: 'moon_get';
    src: url('./static/fonts/moon_get-Heavy.otf');
  }

  * {
    color: #fff;
    font-family: 'moon_get', sans-serif;
  }

  body {
    margin: 0;
    background-color: #242222;
  }

  #apparatus-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    overflow: auto;
    height: 90%;
    margin-top: 2vmin;
    margin-bottom: 3vmin;
  }

  table, th, td {
    font-size: 2vmin;
    font-family: sans-serif;
    overflow: hidden;
    table-layout: fixed;
    text-align: center;
    background-color: #2b2e38;
    width: 98%;
    max-height: 90%;
    border-spacing: 5px;
    border: 2px solid;
    border-top-color: #aa1bd1;
    border-right-color: #1e90ff;
    border-bottom-color: #aa1bd1;
    border-left-color: #1e90ff;
  }

  input {
    font-size: 2vmin;
    font-family: sans-serif;
    overflow: hidden;
    text-align: center;
  }

  button {
    font-size: 2vmin;
    font-family: sans-serif;
    overflow: hidden;
    text-align: center;
    border: 2px solid #dc143c;
    background-color: #2b2e38;
  }

  .header, .key {
    user-select: none;
  }

  #banner {
    min-height: 10vh;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    font-size: calc(10px + 1vmin);
    background-color: #18191c;
    border-radius: 3vmin;
  }
  #banner h1 {
    background: linear-gradient(90deg, rgba(255,0,0,1) 0%, rgba(79,176,85,1) 50%, rgba(51,0,255,1) 100%);
    -webkit-background-clip: text;
    -moz-background-clip: text;
    -webkit-text-fill-color: transparent;
    -moz-text-fill-color: transparent;
  }

  #main {
    max-height: 90vh;
    display: flex;
    flex-direction: row;
    align-items: center;
    justify-content: space-evenly;
    font-size: calc(10px + 1vmin);
    margin-top: 2vmin;
  }

  .sidebar {
    font-family: sans-serif;
    height: 100%;
    width: 0%;
    position: fixed;
    z-index: 1;
    top: 0%;
    left: 0%;
    background-color: #000;
    overflow-x: hidden;
    transition: 0.3s;
  }

  .sidebar p {
    font-family: sans-serif;
    padding: 2vmin;
    padding-left: 3vmin;
    text-decoration: none;
    font-size: 1.5vmin;
    color: #fff;
    display: block;
    overflow: hidden;
    transition: 0.3s;
  }

  .sidebar a {
    font-family: sans-serif;
  }

  .sidebar code {
    font-family: sans-serif;
    background-color: #2b2e38;
  }

  .sidebar #closeSidebar {
    position: absolute;
    top: 0%;
    right: 25px;
    font-size: 36px;
    margin-left: 50px;
    text-decoration: none;
  }

  #openSidebar {
    position: absolute;
    top: 0%;
    left: 0%;
    margin: 5px;
    font-size: 4vmax;
    text-decoration: none;
  }

  </style>
  <!-- End of CSS -->

</html>
