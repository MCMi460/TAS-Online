<!DOCTYPE html>
<!-- Created by Deltaion Lee (MCMi460) on Github -->
<html>
  <head>
    <meta charset = 'utf-8'>

    <!-- Some cosmetics -->
    <link rel = 'shortcut icon' href = './static/images/smotas.png' />
    <meta name = 'author' content = 'MCMi460'>
    <meta name = 'description' content = 'An online Nintendo Switch TAS-ing tool designed for your comfort of use!'>
    <meta name = 'keywords' content = 'TAS, Nintendo Switch, Super Mario Odyssey, Development, Tool'>
    <meta name = 'theme-color' content = '#f018cf'>
    <meta property = 'og:title' content = 'TAS-Online' />
    <meta property = 'og:image' content = './static/images/smotas.png' />

    <title>TAS-Online</title>
  </head>

  <!-- Beginning of JS -->
  <script>
  // TAS-related variables
  const keys = [
    'NONE',
    'KEY_A',
    'KEY_B',
    'KEY_X',
    'KEY_Y',
    'KEY_L',
    'KEY_R',
    'KEY_ZL',
    'KEY_ZR',
    'KEY_PLUS',
    'KEY_MINUS',
    'KEY_DLEFT',
    'KEY_DUP',
    'KEY_DRIGHT',
    'KEY_DDOWN',
    'KEY_LSTICK',
    'KEY_RSTICK',
  ];
  const YES = '✅';
  const NO = '⛔';
  var buffer = '1 KEY_B 0;0 0;0\n6 KEY_ZL 0;0 0;0\n41 KEY_ZL;KEY_Y 0;0 0;0\n43 KEY_X;KEY_A 30000;0 0;0\n44 KEY_A 30000;0 0;0\n45 KEY_A 30000;0 0;0\n46 KEY_A 30000;0 0;0\n47 KEY_A 30000;0 0;0';
  var pasteboard = 'NONE 0;0 0;0';

  // Mouse-related variables
  var lButton = false;

  function onMouseDown() {
    lButton = true;
  } function onMouseUp() {
    lButton = false;
  }
  document.addEventListener('mousedown', onMouseDown);
  document.addEventListener('mouseup', onMouseUp);

  // Important functions
  function setupUI() {
    // Create table columns
    var apparatus = document.getElementById('apparatus');
    var main = document.getElementById('main');
    document.getElementById('file-dialog').value = '';
    try {
    loadHeader();
    populateTable();

    var sec = 0

    function cycle() {
      sec = (Number(sec) + .1).toFixed(1);

      fillText(sec);
    }

    fillText(sec);
    setInterval(cycle,100);

    // Create listener for tableUpdate
    const updateEvent = document.querySelector('#apparatus');
    updateEvent.addEventListener('click', function (e) {
      try {
        let cell = e.target.closest('td');
        if (!cell) {
          return;
        }
        let row = cell.parentElement.rowIndex;
        let col = cell.cellIndex;

        tableUpdate(row, col, cell);
      } catch (e) {
        console.log(e);
        main.innerHTML += `<h3 style='color:#d11b24;'>${e}</h3>`;
      }
    });

    // XY Div
    function checkInput(e) {
      var chr = String.fromCharCode(e.which);
      if ('1234567890-'.indexOf(chr) < 0) {
        return false;
    }};
    let xcoord = document.getElementById('x-coordinate');
    let ycoord = document.getElementById('y-coordinate');
    xcoord.onkeypress = checkInput; xcoord.addEventListener('input', inputUpdate);
    ycoord.onkeypress = checkInput; ycoord.addEventListener('input', inputUpdate);
    // End of listeners

    } catch (e) {
      console.log(e);
      main.innerHTML += `<h3 style='color:#d11b24;'>${e}</h3>`;
    }
  }

  function copy(index) {
    let row = apparatus.children[index].children;

    let frame = row[0].innerHTML;

    let key = [];
    for (let n = 3; n < row.length; n++) {
      if (row[n].innerHTML == YES) {
        key.push(keys[n - 2]);
      }
    }
    if (key == '') {
      key = ['NONE',];
    }
    key = key.join(';');

    lstick = row[1].innerHTML.split(',').map(Number);
    rstick = row[2].innerHTML.split(',').map(Number);

    pasteboard = `${key} ${lstick.join(';')} ${rstick.join(';')}\n`;
    return pasteboard;
  }

  function paste(frame,data = pasteboard) {
    let tempBuffer = buffer.split('\n');

    let possibleFrame = 0;
    for (let i = 0; i < tempBuffer.length; i++) {
      if (!tempBuffer[i] || !/\S/.test(tempBuffer[i])) {
        continue;
      }
      possibleFrame = Number(tempBuffer[i].split(' ')[0]);
      if (possibleFrame > frame) {
        tempBuffer.splice(i, 0, `${frame} ${data}`);
        break;
      }
      possibleFrame += 1;
    }
    if (possibleFrame == Number(tempBuffer[tempBuffer.length - 1].split(' ')[0]) + 1 || (tempBuffer.length == 1 && tempBuffer[0] == '') ) {
      tempBuffer.push(`${frame} ${data}`);
    }
    buffer = tempBuffer.join('\n');

    // Refill the table
    populateTable();
  }

  function newFrame() {
    let frame = 0;
    if (apparatus.children.length > 1) {
      frame = Number(apparatus.children[apparatus.children.length - 1].children[0].innerHTML);
    }
    paste(frame + 1,'NONE 0;0 0;0');
  }

  function delFrame() {
    if (apparatus.children.length > 1) {
      var option = Number(apparatus.children[1].children[0].innerHTML);
    } else {
      return;
    }
    let prompt = window.prompt('Which frame should be removed?', option);
    if (!prompt) {
      return;
    }
    let frame = Number(prompt);
    if (Number.isInteger(frame)) {
      let rows = apparatus.children;
      for (let i = 1; i < rows.length; i++) {
        if (Number(rows[i].children[0].innerHTML) == frame) {
          apparatus.removeChild(rows[i]);
          break;
        }
      }
    }

    tableUpdate(0,0);
  }

  function readFile(event) {
    try {
      var input = event.target;

      var reader = new FileReader();
      reader.onload = function() {
        buffer = reader.result;
        populateTable(true);
      };
      reader.readAsText(input.files[0]);
    } catch (e) {
      console.log(e);
      main.innerHTML += `<h3 style='color:#d11b24;'>${e}</h3>`;
    }
  }

  function downloadBuffer() {
    let elem = document.createElement('a');
    elem.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(buffer));
    elem.setAttribute('download', 'script.txt');

    elem.style.display = 'none';
    document.body.appendChild(elem);

    elem.click();

    document.body.removeChild(elem);
  }

  function loadHeader() {
    let columns = [];
    columns.push(...keys);
    columns.shift();
    columns.unshift('Frame','L-Stick','R-Stick');
    const header = apparatus.querySelector('#header');
    for (let i = 0; i < columns.length; i++)  {
      let td = document.createElement('td');
      let text = columns[i];
      if (i > 2) {
        text = text.substring(4);
      }
      td.innerHTML = text; td.title = text; td.className = 'header';
      header.appendChild(td);
    }
  }

  function populateTable(newFile = false) {
    while (apparatus.children.length > 1) {
      apparatus.removeChild(apparatus.lastChild);
    }

    const lines = buffer.split('\n');
    for (let i = 0; i < lines.length; i++) {
      // Create row
      let line = lines[i].split(' ');
      if (!line || !/\S/.test(line)) {
        continue;
      }
      let row = document.createElement('tr');

      // Frame
      let frame = document.createElement('td'); frame.className = 'frame';
      frame.innerHTML = line[0];
      row.appendChild(frame);

      // Sticks
      let stick1 = line[2].split(';').map(Number); let stick2 = line[3].split(';').map(Number);
      let lstick = document.createElement('td'); let rstick = document.createElement('td');
      lstick.className = 'lstick'; rstick.className = 'rstick';
      lstick.innerHTML = stick1; rstick.innerHTML = stick2;
      lstick.title = stick1; rstick.title = stick2;
      row.appendChild(lstick); row.appendChild(rstick);

      // Keys
      let key = line[1].split(';');
      for (let n = 0; n < key.length; n++) {
        if (!keys.includes(key[n])) {
          throw `Key at frame ${line[0]} [Input #${apparatus.children.length}] does not exist.`
        }
      }
      for (let n = 1; n < keys.length; n++) {
        let keyElem = document.createElement('td'); keyElem.className = 'key';
        if (key.includes(keys[n])) {
          keyElem.innerHTML = YES;
        } else {
          keyElem.innerHTML = NO;
        }
        row.appendChild(keyElem);
      }

      apparatus.appendChild(row);
    }
    buffer = sortTable();
    if (newFile) {
      tableUpdate(0,0);
    }
  }

  function sortTable() {
    let rows = apparatus.children;
    let data = [];
    let possibleFrame = 0;
    for (let i = 1; i < rows.length; i++) {
      let row = rows[i].children;

      // Get frame
      let frame = Number(row[0].innerHTML);

      // Get keys
      let key = [];
      for (let n = 3; n < row.length; n++) {
        if (row[n].innerHTML == YES) {
          key.push(keys[n - 2]);
        }
      }
      if (key == '') {
        key = ['NONE',];
      }
      key = key.join(';');

      // Get sticks
      let lstick = row[1].innerHTML.split(',').map(Number);
      let rstick = row[2].innerHTML.split(',').map(Number);

      if (possibleFrame < frame) {
        possibleFrame = frame;
      } else {
        frame = possibleFrame + 1;
        possibleFrame = frame;
      }

      // Write to string variable
      data.push(`${frame} ${key} ${lstick.join(';')} ${rstick.join(';')}`);
    }
    data.sort(function(elem1,elem2) {
      return Number(elem2.split(' ')[0]) - Number(elem1.split(' ')[0]);
    }).reverse();
    return data.join('\n');
  }

  function removeRow(row) {
    row = apparatus.children[row];
    apparatus.removeChild(row);
    tableUpdate(0,0);
    return row;
  }

  function fillText(sec = 0) {
    let textarea = document.getElementById('sidebar').children[1];

    let date = new Date();
    let time = date.getHours() + ':' + date.getMinutes() + ':' + date.getSeconds();
    let tag = `Buffer updated at ${time} (${sec} seconds of runtime)`;

    textarea.title = tag;
    textarea.innerHTML = '<code>' + buffer.replaceAll('\n','<br>') + `</code><br><br>${tag}`;
  }

  function changeKey(row, col) {
    if (apparatus.children[row].children[col].innerHTML == YES) {
      apparatus.children[row].children[col].innerHTML = NO;
    } else {
      apparatus.children[row].children[col].innerHTML = YES;
    }
  }

  function changeFrame(row, col) {
    let prompt = window.prompt('After which frame should this one be placed?', '1');
    if (prompt) {
      let frame = Number(prompt);
      if (Number.isInteger(frame)) {
        copy(row);
        removeRow(row);
        paste(frame);
      }
    }
  }

  function checkBounds(x,y,radius) {
    // Check if out of bounds
    if (Math.sqrt((x - 0) ** 2 + (y - 0) ** 2)  > radius) {
      // Outside of circle
      return false;
    }
    // Cap X/Y level to radius
    if (x > radius) {
      x = radius;
      return false;
    } else if (x < (-1 * radius)) {
      x = -1 * radius;
      return false;
    }
    if (y > radius) {
      y = radius;
      return false;
    } else if (y < (-1 * radius)) {
      y = -1 * radius;
      return false;
    }
    return true;
  }

  function cursorMove(e) {
    if (!lButton) {
      return;
    }
    let joystick = document.getElementById('joystick');
    let radius = 32767;
    let x = (e.clientX - joystick.offsetLeft - joystick.offsetWidth / 2) * radius / (joystick.offsetWidth / 2);
    let y = ((e.clientY - joystick.offsetTop - joystick.offsetWidth / 2) * -1) * radius / (joystick.offsetWidth / 2);
    x = x.toFixed(0); y = y.toFixed(0);
    if (!checkBounds(x,y,radius)) {
      return;
    }
    // Set coords
    let coords = document.getElementById('coords').children;
    coords[0].value = `${x}`;
    coords[1].value = `${y}`;
    // Move cursor
    let cursor = document.getElementById('joystick-cursor');
    cursor.style.left = `calc(${e.clientX}px - 1vmin)`;
    cursor.style.top = `calc(${e.clientY}px - 1vmin)`;
  }

  function inputUpdate() {
    let joystick = document.getElementById('joystick');
    let coords = document.getElementById('coords').children;
    let cursor = document.getElementById('joystick-cursor');
    let radius = 32767;
    let x = Number(coords[0].value);
    let y = Number(coords[1].value);
    let clientX = x * (joystick.offsetWidth / 2) / radius + joystick.offsetWidth / 2 + joystick.offsetLeft;
    let clientY = y * (joystick.offsetWidth / 2) / radius / -1 + joystick.offsetWidth / 2 + joystick.offsetTop;
    if (!checkBounds(x,y,radius)) {
      coords[0].value = 0;
      coords[1].value = 0;
      inputUpdate();
      return;
    }
    cursor.style.left = `calc(${clientX}px - 1vmin)`;
    cursor.style.top = `calc(${clientY}px - 1vmin)`;
  }

  function changeStick(row, col) {
    let container = document.getElementById('joystick-container');
    let cursor = document.getElementById('joystick-cursor');
    if (row == 0 && col == 0) {
      // Get coordinates to write
      let x = document.getElementById('x-coordinate').value;
      let y = document.getElementById('y-coordinate').value;

      // Get location of cell
      let cellR = container.title.split(', ')[0];
      let cellC = container.title.split(', ')[1];

      apparatus.children[cellR].children[cellC].innerHTML = `${x},${y}`;
      apparatus.children[cellR].children[cellC].title = `${x},${y}`;
      container.title = '';

      // Close joystick-related elements
      container.style.width = '0%';
      cursor.style.display = 'none';
      
      tableUpdate(0,0);
      return;
    }
    container.style.width = '100%';
    container.title = `${row}, ${col}`;
    cursor.style.display = 'block';
    let [x,y] = apparatus.children[row].children[col].innerHTML.split(',').map(Number);
    document.getElementById('x-coordinate').value = `${x}`;
    document.getElementById('y-coordinate').value = `${y}`;
    inputUpdate();
  }

  // Events

  function tableUpdate(row, col, cell = false) {
    if (cell) {
      if (cell.className == 'frame') {
        changeFrame(row, col);
      } else if (cell.className == 'lstick' || cell.className == 'rstick') {
        changeStick(row, col);
      } else if (cell.className == 'key') {
        changeKey(row, col);
      }
    }

    // Sort table, then write the changes
    buffer = sortTable();
    // Fill table
    populateTable();
  }

  function sidebar(toggle) {
    let width = '0%';
    if (toggle) {
      width = '25%';
    }
    document.getElementById('sidebar').style.width = width;
  }

  </script>
  <!-- End of JS -->

  <!-- Beginning of HTML -->
  <body onload='setupUI();'>

    <div
      id = 'sidebar'
      class = 'sidebar'
    >

      <a href = 'javascript:sidebar(false);' id = 'closeSidebar'>
        &times;
      </a>

      <p>

      </p>

      <p>
        Created and designed by <a href = 'https://github.com/MCMi460' target = '_blank'>Deltaion Lee (MCMi460)</a>
        <br><br>
        Built using <a href = 'https://github.com/hamhub7/tas-script/blob/master/lua/lib/nxtas.md' target = '_blank'>nx-TAS</a> by <a href = 'https://github.com/hamhub7' target = '_blank'>hamhub7</a>
        <br><br>
        <a href = 'https://github.com/MCMi460/TAS-Online' target = '_blank'>See on Github</a>!
        <br><br><br>
        <a href = 'javascript:window.location.reload();'>Reset page</a>
      </p>

    </div>

    <div
      id = 'joystick-container'
    >

      <div
        id = 'joystick'
        onmousemove = 'cursorMove(event)'
      >
        <div id = 'joystick-cursor'></div>
      </div>

      <div
        id = 'coords'
      >
        <!-- Coords go here -->
        <input type = 'number' id = 'x-coordinate' name = 'X-Value' min = '-32767' max = '32767' value = '0'>
        <input type = 'number' id = 'y-coordinate' name = 'Y-Value' min = '-32767' max = '32767' value = '0'>
      </div>

      <div
        id = 'confirm-joystick'
      >
        <button onclick = 'changeStick(0,0);'>Confirm Changes</button>
      </div>

    </div>

    <div
      id = 'banner'
    >

      <a href = 'javascript:sidebar(true);' id = 'openSidebar'>&#9776;</a>
      <h1><i>TAS-Online Editor</i></h1>

    </div>

    <div
      id = 'main'
    >

    <input type = 'file' id = 'file-dialog' accept = 'text/plain' onchange = 'readFile(event);'>
    <button onclick = 'downloadBuffer();'>Save progress</button>
    <button onclick = 'newFrame();'>Add Frame</button>
    <button onclick = 'delFrame();'>Remove Frame</button>

    </div>

    <div
      id = 'apparatus-container'
    >
      <table id = 'apparatus'>
        <tr id = 'header'>

        </tr>
      </table>
    </div>

  </body>
  <!-- End of HTML -->

  <!-- Beginning of CSS -->
  <style>

  @font-face {
    font-family: 'moon_get';
    src: url('./static/fonts/moon_get-Heavy.otf');
  }

  * {
    color: #fff;
    font-family: 'moon_get', sans-serif;
  }

  body {
    margin: 0;
    background-color: #242222;
  }

  #apparatus-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    overflow: auto;
    height: 90%;
    margin-top: 2vmin;
    margin-bottom: 3vmin;
  }

  table, th, td {
    font-size: 2vmin;
    font-family: sans-serif;
    overflow: hidden;
    table-layout: fixed;
    text-align: center;
    background-color: #2b2e38;
    width: 98%;
    max-height: 90%;
    border-spacing: 5px;
    border: 2px solid;
    border-top-color: #aa1bd1;
    border-right-color: #1e90ff;
    border-bottom-color: #aa1bd1;
    border-left-color: #1e90ff;
  }

  input {
    font-size: 2vmin;
    font-family: sans-serif;
    overflow: hidden;
    text-align: center;
  }

  button {
    font-size: 2vmin;
    font-family: sans-serif;
    overflow: hidden;
    text-align: center;
    border: 2px solid #dc143c;
    background-color: #2b2e38;
  }

  .header, .key {
    user-select: none;
  }

  #banner {
    min-height: 10vh;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    font-size: calc(10px + 1vmin);
    background-color: #18191c;
    border-radius: 3vmin;
  }
  #banner h1 {
    background: linear-gradient(90deg, rgba(255,0,0,1) 0%, rgba(79,176,85,1) 50%, rgba(51,0,255,1) 100%);
    -webkit-background-clip: text;
    -moz-background-clip: text;
    -webkit-text-fill-color: transparent;
    -moz-text-fill-color: transparent;
  }

  #main {
    max-height: 90vh;
    display: flex;
    flex-direction: row;
    align-items: center;
    justify-content: space-evenly;
    font-size: calc(10px + 1vmin);
    margin-top: 2vmin;
  }

  .sidebar {
    font-family: sans-serif;
    height: 100%;
    width: 0%;
    position: fixed;
    z-index: 1;
    top: 0%;
    left: 0%;
    background-color: #000;
    overflow-x: hidden;
    transition: 0.3s;
    opacity: 0.9;
  }

  .sidebar p {
    font-family: sans-serif;
    padding: 2vmin;
    padding-left: 3vmin;
    text-decoration: none;
    font-size: 1.5vmin;
    color: #fff;
    display: block;
    overflow: hidden;
    transition: 0.3s;
  }

  .sidebar a {
    font-family: sans-serif;
  }

  .sidebar code {
    font-family: sans-serif;
    background-color: #2b2e38;
  }

  .sidebar #closeSidebar {
    position: absolute;
    top: 0%;
    right: 25px;
    font-size: 36px;
    margin-left: 50px;
    text-decoration: none;
  }

  #openSidebar {
    position: absolute;
    top: 0%;
    left: 0%;
    margin: 5px;
    font-size: 4vmax;
    text-decoration: none;
  }

  #joystick-container {
    font-family: sans-serif;
    height: 100%;
    width: 0%;
    position: fixed;
    z-index: 2;
    top: 0%;
    right: 0%;
    background-color: #000;
    overflow-x: hidden;
    opacity: 0.9;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
  }

  #joystick {
    width: 80vh;
    height: 80vh;
    border: 1vmin solid #c3c3c3;
    border-radius: 100%;
    background-color: #59504f;
    opacity: 1;
  }

  #joystick-cursor {
    display: none;
    width: 2vmin;
    height: 2vmin;
    border-radius: 100%;
    background-color: #f71d05;
    position: fixed;
    top: calc(50% - 1vmin);
    left: calc(50% - 1vmin);
    z-index: 3;
  }

  #coords input {
    margin-top: 1vmin;
    margin-bottom: 1vmin;
    color: #000;
  }

  </style>
  <!-- End of CSS -->

</html>
