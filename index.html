<!DOCTYPE html>
<!-- Created by Deltaion Lee (MCMi460) on Github -->
<html>
  <head>
    <meta charset="utf-8">
    <title>TAS-Online</title>
  </head>

  <!-- Beginning of JS -->
  <script>
  const keys = [
    'NONE',
    'KEY_A',
    'KEY_B',
    'KEY_X',
    'KEY_Y',
    'KEY_L',
    'KEY_R',
    'KEY_ZL',
    'KEY_ZR',
    'KEY_PLUS',
    'KEY_MINUS',
    'KEY_DLEFT',
    'KEY_DUP',
    'KEY_DRIGHT',
    'KEY_DDOWN',
    'KEY_LSTICK',
    'KEY_RSTICK',
  ];
  const YES = '✅';
  const NO = '⛔';
  var buffer = '1 KEY_A 0;0 0;0\n2 KEY_B 0;0 0;0';
  var pasteboard = 'NONE 0;0 0;0';

  function setupUI() {
    // Create table columns
    var apparatus = document.getElementById('apparatus');
    var main = document.getElementById('main');
    document.getElementById('file-dialog').value = '';
    try {
    loadHeader();
    populateTable();

    var sec = 0

    function cycle() {
      sec = (Number(sec) + .01).toFixed(2);
    }

    //setInterval(cycle,10);

    // Create listener for tableUpdate
    const updateEvent = document.querySelector('#apparatus');
    updateEvent.addEventListener('click', function (e) {
      try {
        let cell = e.target.closest('td');
        if (!cell) {
          return;
        }
        let row = cell.parentElement.rowIndex;
        let col = cell.cellIndex;

        if (row != 0 && cell.className == 'frame') {
          let frame = Number(window.prompt('After which frame should this one be placed?', '1'));
          if (frame || frame == 0) {
            console.log(frame);
            copy(row);
            removeRow(row);
            paste(frame);
          }
        } else if (row != 0 && cell.className == 'key') {
          if (apparatus.children[row].children[col].innerHTML == YES) {
            apparatus.children[row].children[col].innerHTML = NO;
          } else {
            apparatus.children[row].children[col].innerHTML = YES;
          }
        }

        tableUpdate(row, col);
      } catch (e) {
        console.log(e);
        main.innerHTML += `<h3 style='color:#d11b24;'>${e}</h3>`;
      }
    });
    // End of listeners

    } catch (e) {
      console.log(e);
      main.innerHTML += `<h3 style='color:#d11b24;'>${e}</h3>`;
    }
  }

  function copy(index) {
    let row = apparatus.children[index].children;

    let frame = row[0].innerHTML;

    let key = [];
    for (let n = 3; n < row.length; n++) {
      if (row[n].innerHTML == YES) {
        key.push(keys[n - 2]);
      }
    }
    if (key == '') {
      key = ['NONE',];
    }
    key = key.join(';');

    lstick = row[1].innerHTML.split(',').map(Number);
    rstick = row[2].innerHTML.split(',').map(Number);

    pasteboard = `${key} ${lstick.join(';')} ${rstick.join(';')}\n`;
    return pasteboard;
  }

  function paste(frame,data = pasteboard) {
    let paste = data.split(' ');

    let row = document.createElement('tr');

    let frameCell = document.createElement('td'); frameCell.className = 'frame';
    frameCell.innerHTML = Number(frame);
    row.appendChild(frameCell);

    // Sticks
    let stick1 = paste[1].split(';').map(Number); let stick2 = paste[2].split(';').map(Number);
    let lstick = document.createElement('td'); let rstick = document.createElement('td');
    lstick.className = 'lstick'; rstick.className = 'rstick';
    lstick.innerHTML = stick1; rstick.innerHTML = stick2;
    row.appendChild(lstick); row.appendChild(rstick);

    let key = paste[0].split(';');
    for (let n = 0; n < key.length; n++) {
      if (!keys.includes(key[n])) {
        throw `Key at frame ${frame} does not exist.`
      }
    }
    for (let n = 1; n < keys.length; n++) {
      let keyElem = document.createElement('td'); keyElem.className = 'key';
      if (key.includes(keys[n])) {
        keyElem.innerHTML = YES;
      } else {
        keyElem.innerHTML = NO;
      }
      row.appendChild(keyElem);
    }

    let rows = apparatus.children;
    let currentFrame = false;
    let lastFrame = 0;
    for (let i = 1; i < rows.length; i++) {
      let currentFrame = rows[i].children;

      if (Number(currentFrame[0].innerHTML) > frame) {
        let frameToInsert = currentFrame;
        break;
      } else {
        lastFrame = Number(currentFrame[0].innerHTML);
      }
    }
    if (currentFrame != false) {
      apparatus.insertBefore(row, currentFrame);
    } else if (lastFrame < frame) {
      apparatus.appendChild(row);
    } else {
      console.log(frame);
      apparatus.insertBefore(row, rows[1]);
    }

    tableUpdate(0,0);
  }

  function newFrame() {
    paste(Number(apparatus.children[apparatus.children.length - 1].children[0].innerHTML) + 1,'NONE 0;0 0;0');
  }

  function readFile(event) {
    try {
      var input = event.target;

      var reader = new FileReader();
      reader.onload = function() {
        buffer = reader.result;
        populateTable(true);
      };
      reader.readAsText(input.files[0]);
    } catch (e) {
      console.log(e);
      main.innerHTML += `<h3 style='color:#d11b24;'>${e}</h3>`;
    }
  }

  function downloadBuffer() {
    let elem = document.createElement('a');
    elem.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(buffer));
    elem.setAttribute('download', 'script.txt');

    elem.style.display = 'none';
    document.body.appendChild(elem);

    elem.click();

    document.body.removeChild(elem);
  }

  function loadHeader() {
    let columns = [];
    columns.push(...keys);
    columns.shift();
    columns.unshift('Frame','L-Stick','R-Stick');
    const header = apparatus.querySelector('#header');
    for (let i = 0; i < columns.length; i++)  {
      let td = document.createElement('td');
      let text = columns[i];
      if (i > 2) {
        text = text.substring(4);
      }
      td.innerHTML = text; td.title = text; td.className = 'header';
      header.appendChild(td);
    }
  }

  function populateTable(newFile = false) {
    while (apparatus.children.length > 1) {
      apparatus.removeChild(apparatus.lastChild);
    }

    const lines = buffer.split('\n');
    for (let i = 0; i < lines.length; i++) {
      // Create row
      let line = lines[i].split(' ');
      if (!line || !/\S/.test(line)) {
        continue;
      }
      let row = document.createElement('tr');

      // Frame
      let frame = document.createElement('td'); frame.className = 'frame';
      frame.innerHTML = line[0];
      row.appendChild(frame);

      // Sticks
      let stick1 = line[2].split(';').map(Number); let stick2 = line[3].split(';').map(Number);
      let lstick = document.createElement('td'); let rstick = document.createElement('td');
      lstick.className = 'lstick'; rstick.className = 'rstick';
      lstick.innerHTML = stick1; rstick.innerHTML = stick2;
      row.appendChild(lstick); row.appendChild(rstick);

      // Keys
      let key = line[1].split(';');
      for (let n = 0; n < key.length; n++) {
        if (!keys.includes(key[n])) {
          throw `Key at frame ${line[0]} [Input #${apparatus.children.length}] does not exist.`
        }
      }
      for (let n = 1; n < keys.length; n++) {
        let keyElem = document.createElement('td'); keyElem.className = 'key';
        if (key.includes(keys[n])) {
          keyElem.innerHTML = YES;
        } else {
          keyElem.innerHTML = NO;
        }
        row.appendChild(keyElem);
      }

      apparatus.appendChild(row);
    }
    buffer = sortTable();
    if (newFile) {
      tableUpdate(0,0);
    }
  }

  function sortTable() {
    let rows = apparatus.children;
    let data = [];
    let possibleFrame = 0;
    for (let i = 1; i < rows.length; i++) {
      let row = rows[i].children;

      // Get frame
      let frame = Number(row[0].innerHTML);

      // Get keys
      let key = [];
      for (let n = 3; n < row.length; n++) {
        if (row[n].innerHTML == YES) {
          key.push(keys[n - 2]);
        }
      }
      if (key == '') {
        key = ['NONE',];
      }
      key = key.join(';');

      // Get sticks
      let lstick = row[1].innerHTML.split(',').map(Number);
      let rstick = row[2].innerHTML.split(',').map(Number);

      if (possibleFrame < frame) {
        possibleFrame = frame;
      } else {
        frame = possibleFrame + 1;
        possibleFrame = frame;
      }

      // Write to string variable
      data.push(`${frame} ${key} ${lstick.join(';')} ${rstick.join(';')}`);
    }
    data.sort(function(elem) {
      return Number(elem.split(' ')[0]);
    }).reverse();
    console.log(data);
    return data.join('\n');
  }

  function removeRow(row) {
    row = apparatus.children[row];
    apparatus.removeChild(row);
    tableUpdate(0,0);
    return row;
  }

  function changeStick(row, col) {

  }

  // Events

  function tableUpdate(row, col) {
    if (col == keys.length + 2 && row != 0) {
      removeRow(row);
    } else if (3 > col > 0 && row != 0) {
      changeStick(row, col);
    }

    // Sort table, then write the changes
    buffer = sortTable();
    // Fill table
    populateTable();
  }

  </script>
  <!-- End of JS -->

  <!-- Beginning of HTML -->
  <body onload='setupUI();'>

    <div
      id = 'banner'
    >

      <h1><i>TAS-Online Editor</i></h1>

    </div>

    <div
      id = 'main'
    >

    <input type = 'file' id = 'file-dialog' accept = 'text/plain' onchange = 'readFile(event);'>
    <button onclick = 'downloadBuffer();'>Save progress</button>
    <button onclick = 'newFrame();'>Add Frame</button>

    </div>

    <div
      id = 'apparatus-container'
    >
      <table id = 'apparatus'>
        <tr id = 'header'>

        </tr>
      </table>
    </div>

  </body>
  <!-- End of HTML -->

  <!-- Beginning of CSS -->
  <style>

  @font-face {
    font-family: 'moon_get';
    src: url('./static/fonts/moon_get-Heavy.otf');
  }

  * {
    color: #fff;
    font-family: 'moon_get', sans-serif;
  }

  body {
    margin: 0;
    background-color: #242222;
  }

  #apparatus-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    overflow: auto;
    height: 90%;
    margin-top: 2vmin;
    margin-bottom: 3vmin;
  }

  table, th, td {
    font-size: 2vmin;
    font-family: sans-serif;
    overflow: hidden;
    table-layout: fixed;
    text-align: center;
    background-color: #2b2e38;
    width: 98%;
    max-height: 90%;
    border-spacing: 5px;
    border: 2px solid;
    border-top-color: #aa1bd1;
    border-right-color: #1e90ff;
    border-bottom-color: #aa1bd1;
    border-left-color: #1e90ff;
  }

  input {
    font-size: 2vmin;
    font-family: sans-serif;
    overflow: hidden;
    text-align: center;
  }

  button {
    font-size: 2vmin;
    font-family: sans-serif;
    overflow: hidden;
    text-align: center;
    border: 2px solid #dc143c;
    background-color: #2b2e38;
  }

  .header, .key {
    user-select: none;
  }

  #banner {
    min-height: 10vh;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    font-size: calc(10px + 1vmin);
    background-color: #18191c;
    border-radius: 3vmin;
  }
  #banner h1 {
    background: linear-gradient(90deg, rgba(255,0,0,1) 0%, rgba(79,176,85,1) 50%, rgba(51,0,255,1) 100%);
    -webkit-background-clip: text;
    -moz-background-clip: text;
    -webkit-text-fill-color: transparent;
    -moz-text-fill-color: transparent;
  }

  #main {
    max-height: 90vh;
    display: flex;
    flex-direction: row;
    align-items: center;
    justify-content: space-evenly;
    font-size: calc(10px + 1vmin);
    margin-top: 2vmin;
  }

  </style>
  <!-- End of CSS -->

</html>
